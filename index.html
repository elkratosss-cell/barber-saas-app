<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BarberSaaS - Cargando...</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--color-primary)',
                        occupied: '#e5e7eb',
                        selected: 'var(--color-primary)',
                    },
                    fontFamily: { sans: ['Poppins', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        :root { --color-primary: #8B4513; }
        html, body { overflow-x: hidden; width: 100%; position: relative; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slot-btn { transition: all 0.2s; position: relative; }
        .slot-btn.available:hover { transform: scale(1.05); border-color: var(--color-primary); }
        .slot-btn.selected { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
        .slot-btn.occupied { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; opacity: 0.7; }
        .spots-badge { position: absolute; top: -5px; right: -5px; background-color: #10B981; color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 999px; font-weight: bold; }
        
        /* Personalizaci√≥n del Calendario Flatpickr */
        .flatpickr-calendar { border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: none; }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: var(--color-primary) !important;
            border-color: var(--color-primary) !important;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800 font-sans pb-10">

    <div id="loader" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
    </div>

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative hidden flex flex-col w-full overflow-hidden">
        
        <header class="p-6 text-center bg-primary text-white rounded-b-3xl shadow-lg relative z-10 transition-colors duration-500">
            <h1 id="shopName" class="text-3xl font-bold mb-1">Cargando...</h1>
            <p id="headerSub" class="text-sm opacity-90"></p>
            
            <div id="adminDropdownContainer" class="absolute top-4 right-4 text-white">
                <button onclick="toggleDropdown('adminDropdown')" class="opacity-60 hover:opacity-100 transition relative">
                    <i class="fas fa-cog text-xl"></i>
                </button>
                
                <div id="adminDropdown" class="hidden absolute right-0 mt-3 w-40 bg-white rounded-lg shadow-xl py-1 text-gray-800 text-sm z-50">
                    <div id="adminOptions" class="hidden">
                        <a href="#" onclick="openAccountSettingsAndCloseDropdown(event)" class="block px-4 py-2 hover:bg-gray-100 font-medium">
                            <i class="fas fa-user-circle mr-2"></i> Cuenta
                        </a>
                        <a href="#" onclick="adminLogoutAndCloseDropdown(event)" class="block px-4 py-2 hover:bg-gray-100 text-red-500 font-medium border-t mt-1 pt-1">
                            <i class="fas fa-sign-out-alt mr-2"></i> Salir
                        </a>
                    </div>
                    <div id="loginOption">
                        <a href="#" onclick="openAdminLoginAndCloseDropdown(event)" class="block px-4 py-2 hover:bg-gray-100 font-medium text-primary">
                            <i class="fas fa-sign-in-alt mr-2"></i> Ingresar
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div id="shopNotice" class="hidden bg-yellow-100 text-yellow-800 px-4 py-2 text-sm text-center border-b border-yellow-200">
            <i class="fas fa-bullhorn mr-1"></i> <span id="shopNoticeText"></span>
        </div>

        <main class="p-6 flex-grow">
            
            <section id="viewLogin" class="fade-in">
                <div class="text-center mb-8 mt-4">
                    <h2 class="text-2xl font-bold text-gray-800">Reserva tu turno</h2>
                    <p class="text-gray-500">R√°pido, f√°cil y sin esperas.</p>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Celular</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3.5 text-gray-400">üá∫üáæ +598</span>
                            <input type="tel" id="loginPhone" placeholder="99123456" class="w-full pl-24 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary outline-none text-lg" maxlength="9" autocomplete="off">
                        </div>
                    </div>
                    <div id="pinSection" class="hidden fade-in">
                        <label class="block text-sm font-bold text-gray-700 mb-1">PIN de Acceso</label>
                        <div class="relative">
                            <input type="password" id="loginPin" inputmode="numeric" placeholder="****" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary outline-none text-center text-2xl tracking-widest" maxlength="4" autocomplete="new-password">
                            <button type="button" onclick="togglePinVisibility()" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-primary transition">
                                <i id="pinToggleIcon" class="fas fa-eye"></i>
                            </button>
                        </div>
                        <p id="pinHint" class="text-xs text-gray-400 mt-2 text-center"></p>
                    </div>
                    <div id="nameSection" class="hidden fade-in">
                        <label class="block text-sm font-bold text-gray-700 mb-1">Nombre</label>
                        <input type="text" id="loginName" placeholder="Tu nombre" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary outline-none" autocomplete="off">
                    </div>
                    <button id="btnActionLogin" class="w-full bg-primary text-white py-4 rounded-xl font-bold text-lg shadow-md hover:opacity-90 transition mt-2">Ingresar</button>
                </div>
            </section>

            <section id="viewClient" class="hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-bold text-xl">Hola, <span id="clientNameDisplay" class="text-primary"></span> üëã</h2>
                    <button onclick="logout()" class="text-sm text-gray-500 underline">Salir</button>
                </div>

                <div id="activeAppointmentCard" class="hidden bg-white border-l-4 border-primary shadow-md rounded-r-xl p-5 mb-8">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide font-bold">Tu turno</p>
                            <h3 id="activeDate" class="text-lg font-bold text-gray-800 mt-1">...</h3>
                            <p id="activeTime" class="text-2xl font-bold text-primary my-1">...</h3>
                            <p id="activeService" class="text-sm text-gray-600">...</p>
                        </div>
                        <button onclick="cancelMyAppointment()" class="text-red-500 text-xs border border-red-200 px-3 py-1 rounded hover:bg-red-50">Cancelar</button>
                    </div>
                </div>

                <div id="newBookingContainer">
                    <h3 class="font-bold text-gray-700 mb-4 text-lg">üìÖ Nuevo Turno</h3>
                    <input type="text" id="datePicker" class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-6 focus:ring-2 focus:ring-primary outline-none bg-white" placeholder="Selecciona una fecha">
                    
                    <div id="closedMessage" class="hidden text-center text-red-500 py-4 bg-red-50 rounded-xl mb-6">
                        El local permanece cerrado este d√≠a.
                    </div>

                    <div id="slotsGrid" class="grid grid-cols-3 gap-3 mb-6"></div>

                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Servicio</label>
                        <select id="serviceSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white"></select>
                    </div>
                    <button id="btnConfirmBooking" class="w-full bg-primary text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Confirmar</button>
                </div>
            </section>

            <section id="viewBarber" class="hidden fade-in h-full">
                <div class="flex border-b mb-6">
                    <button onclick="switchAdminTab('agenda')" id="tabAgenda" class="flex-1 py-3 font-bold text-primary border-b-2 border-primary">Agenda</button>
                    <button onclick="switchAdminTab('config')" id="tabConfig" class="flex-1 py-3 text-gray-500 hover:text-primary">Configuraci√≥n</button>
                </div>

                <div id="panelAgenda">
                    <div class="flex justify-between items-center mb-4">
                        <input type="text" id="barberDatePicker" class="px-3 py-2 border rounded-lg text-sm bg-white font-medium w-40 text-center">
                        <button onclick="logout()" class="text-gray-400 hover:text-red-500 text-sm"><i class="fas fa-sign-out-alt"></i> Salir</button>
                    </div>
                    <div id="occupancySummary" class="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide"></div>
                    <div id="barberAppointmentsList" class="space-y-3 pb-20"></div>
                </div>

                <div id="panelConfig" class="hidden pb-20">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">üè¢ Datos del Local</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-500 block">Apertura</label>
                                <input type="tel" inputmode="numeric" id="cfgOpen" placeholder="09:00" maxlength="5" class="w-full p-2 border rounded text-center font-mono time-mask" oninput="maskTime(this)">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block">Cierre</label>
                                <input type="tel" inputmode="numeric" id="cfgClose" placeholder="20:00" maxlength="5" class="w-full p-2 border rounded text-center font-mono time-mask" oninput="maskTime(this)">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-500 block">Duraci√≥n Turno (min)</label>
                                <select id="cfgInterval" class="w-full p-2 border rounded bg-white">
                                    <option value="30">30 min</option>
                                    <option value="45">45 min</option>
                                    <option value="60">60 min</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block">Barberos (Sillas)</label>
                                <input type="tel" inputmode="numeric" id="cfgChairs" class="w-full p-2 border rounded" min="1" onchange="renderBarberBreaks()">
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-gray-500 block mb-2">D√≠as Abiertos</label>
                            <div class="flex justify-between gap-1">
                                <label class="cursor-pointer flex flex-col items-center"><input type="checkbox" name="workday" value="1"><span class="text-xs mt-1">Lun</span></label>
                                <label class="cursor-pointer flex flex-col items-center"><input type="checkbox" name="workday" value="2"><span class="text-xs mt-1">Mar</span></label>
                                <label class="cursor-pointer flex flex-col items-center"><input type="checkbox" name="workday" value="3"><span class="text-xs mt-1">Mi√©</span></label>
                                <label class="cursor-pointer flex flex-col items-center"><input type="checkbox" name="workday" value="4"><span class="text-xs mt-1">Jue</span></label>
                                <label class="cursor-pointer flex flex-col items-center"><input type="checkbox" name="workday" value="5"><span class="text-xs mt-1">Vie</span></label>
                                <label class="cursor-pointer flex flex-col items-center"><input type="checkbox" name="workday" value="6"><span class="text-xs mt-1">S√°b</span></label>
                                <label class="cursor-pointer flex flex-col items-center"><input type="checkbox" name="workday" value="0"><span class="text-xs mt-1">Dom</span></label>
                            </div>
                        </div>

                        <h3 class="font-bold text-sm text-gray-800 pt-4">üïí Pausas Individuales</h3>
                        <p class="text-xs text-gray-400 mb-2">Escribe la hora (ej: 1300)</p>
                        <div id="barberBreaksContainer" class="space-y-3 p-3 border rounded-lg bg-gray-50"></div>

                        <div>
                            <label class="text-xs text-gray-500 block mb-2">Servicios y Precios</label>
                            <div id="servicesList" class="space-y-2 mb-2"></div>
                            <div class="flex gap-2 items-center">
                                <input type="text" id="newSvcName" placeholder="Nombre" class="flex-1 min-w-0 p-2 border rounded text-sm">
                                <input type="tel" inputmode="numeric" id="newSvcPrice" placeholder="$" class="w-20 flex-shrink-0 p-2 border rounded text-sm">
                                <button onclick="addServiceDOM()" class="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-gray-200 text-gray-800 rounded hover:bg-gray-300 font-bold text-xl">+</button>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-gray-500 block">Mensaje de Aviso</label>
                            <input type="text" id="cfgMsg" placeholder="Ej: Vuelvo el martes" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="flex items-center gap-3 border p-3 rounded-lg">
                            <input type="checkbox" id="cfgShowWpp" class="w-5 h-5">
                            <div class="flex-1">
                                <label class="text-sm font-bold block">Mostrar WhatsApp</label>
                                <input type="tel" inputmode="numeric" id="cfgWppNumber" placeholder="099123456" class="w-full text-sm border-b outline-none">
                            </div>
                        </div>
                        
                        <button onclick="saveConfig()" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg mt-4">Guardar Cambios</button>
                    </div>
                </div>
            </section>

            <footer id="footerWpp" class="hidden mt-auto pt-6 text-center pb-4">
                <a id="wppLink" href="#" target="_blank" class="inline-flex items-center gap-2 text-green-600 font-bold bg-green-50 px-4 py-2 rounded-full hover:bg-green-100 transition">
                    <i class="fab fa-whatsapp text-xl"></i> Cont√°ctanos
                </a>
            </footer>

            <button id="fabAdd" onclick="toggleModal('modalManualBooking')" class="hidden fixed bottom-6 right-6 bg-primary text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition z-40">
                <i class="fas fa-plus"></i>
            </button>
        </main>
    </div>

    <div id="modalBarberLogin" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-center text-primary">Acceso Admin</h3>
            <input type="text" id="adminUsername" placeholder="Nombre de Usuario" class="w-full mb-3 px-4 py-3 border rounded-xl" autocomplete="off">
            <input type="password" id="adminPass" placeholder="Contrase√±a" class="w-full mb-6 px-4 py-3 border rounded-xl">
            <div class="flex gap-3">
                <button onclick="toggleModal('modalBarberLogin')" class="flex-1 py-3 text-gray-500">Cancelar</button>
                <button onclick="loginBarber()" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold">Entrar</button>
            </div>
        </div>
    </div>

    <div id="modalManualBooking" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-primary">Agendar Turno</h3>
                <button onclick="toggleModal('modalManualBooking')" class="text-gray-400">‚úï</button>
            </div>
            <div class="space-y-3">
                <input type="tel" id="manualPhone" placeholder="Celular (Opcional)" class="w-full px-4 py-3 border rounded-xl" autocomplete="off">
                <input type="text" id="manualName" placeholder="Nombre" class="w-full px-4 py-3 border rounded-xl" autocomplete="off">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="manualDate" class="px-4 py-3 border rounded-xl text-center" placeholder="Fecha">
                    <input type="tel" inputmode="numeric" id="manualTime" placeholder="Hora (09:00)" maxlength="5" class="w-full px-4 py-3 border rounded-xl font-mono text-center time-mask" oninput="maskTime(this)">
                </div>
                <select id="manualService" class="w-full px-4 py-3 border rounded-xl"></select>
                <button onclick="createManualBooking()" class="w-full bg-primary text-white py-3 rounded-xl font-bold mt-2">Guardar</button>
            </div>
        </div>
    </div>

    <div id="modalAccountSettings" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-primary">üîë Configuraci√≥n de Cuenta</h3>
                <button onclick="toggleModal('modalAccountSettings')" class="text-gray-400">‚úï</button>
            </div>
            <div class="space-y-4 p-4 border rounded-xl bg-gray-50">
                <p class="text-sm text-gray-600 font-bold border-b pb-2">Cambiar Contrase√±a</p>
                <input type="password" id="currentPass" placeholder="Contrase√±a Actual" class="w-full p-3 border rounded-xl text-sm">
                <input type="password" id="newPass" placeholder="Nueva Contrase√±a" class="w-full p-3 border rounded-xl text-sm">
                <input type="password" id="confirmNewPass" placeholder="Confirmar Nueva Contrase√±a" class="w-full p-3 border rounded-xl text-sm">
                <button onclick="changeAdminPassword()" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold shadow-md hover:bg-blue-600 transition">Actualizar Contrase√±a</button>
            </div>
        </div>
    </div>
    
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center">
            <i id="confirmIcon" class="fas fa-exclamation-triangle text-3xl text-red-500 mb-4"></i>
            <h3 id="confirmTitle" class="font-bold text-xl mb-3 text-gray-800">Confirmaci√≥n</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6">¬øEst√°s seguro de continuar?</p>
            <div class="flex gap-3">
                <button id="confirmBtnCancel" class="flex-1 py-3 text-gray-500 border border-gray-300 rounded-xl hover:bg-gray-100 transition">Cancelar</button>
                <button id="confirmBtnAccept" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition">Aceptar</button>
            </div>
        </div>
    </div>
    
    <div id="toastNotification" class="fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-xl z-50 hidden transition-all duration-300 transform opacity-0">
        Turno confirmado üëç
    </div>

    <script>
        const SUPABASE_URL = 'https://hqoyjsngydafaagsrzlg.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhxb3lqc25neWRhZmFhZ3NyemxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MDI5MDQsImV4cCI6MjA3OTk3ODkwNH0.WyTlANZLTRd6IlhxuDlQai8Zz6dgexGPvwXmBr7HsZs';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentShop = null;
        let currentUser = null; 
        let selectedTime = null;
        let shopConfig = {}; 
        let generatedHours = []; 
        let calendarInstance = null; // Instancia de Flatpickr cliente
        let adminCalendarInstance = null; // Instancia de Flatpickr admin
        let manualCalendarInstance = null; // Instancia de Flatpickr manual
        
        const CLIENT_STORAGE_KEY = 'barbersaas_client_id';
        const ADMIN_STORAGE_KEY = 'barbersaas_admin_id';

        // Configuraci√≥n com√∫n de Flatpickr
        const flatpickrConfig = {
            locale: "es",
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "j \\de F, Y",
            disableMobile: true, // Forzar estilo propio en m√≥viles
            minDate: "today",
            theme: "material_orange" // Puedes buscar temas CSS o dejar el default
        };

        function maskTime(input) {
            let v = input.value.replace(/\D/g, ''); 
            if (v.length > 4) v = v.slice(0, 4);
            if (v.length >= 3) {
                v = v.slice(0, 2) + ':' + v.slice(2);
            }
            input.value = v;
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toastNotification');
            toast.innerText = message;
            toast.classList.remove('bg-green-500', 'bg-red-500');
            toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            toast.classList.remove('hidden', 'opacity-0', 'scale-90');
            toast.classList.add('opacity-100', 'scale-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'scale-100');
                toast.classList.add('opacity-0', 'scale-90');
                setTimeout(() => toast.classList.add('hidden'), 300); 
            }, 3000); 
        }
        
        function togglePinVisibility() {
            const pinInput = document.getElementById('loginPin');
            const pinIcon = document.getElementById('pinToggleIcon');
            if (pinInput.type === 'password') {
                pinInput.type = 'text'; pinIcon.classList.remove('fa-eye'); pinIcon.classList.add('fa-eye-slash');
            } else {
                pinInput.type = 'password'; pinIcon.classList.remove('fa-eye-slash'); pinIcon.classList.add('fa-eye');
            }
        }
        
        function showConfirmationModal(message, onAccept, onCancel) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmMessage').innerText = message;
            const acceptBtn = document.getElementById('confirmBtnAccept');
            const cancelBtn = document.getElementById('confirmBtnCancel');
            
            acceptBtn.onclick = () => { onAccept(); modal.classList.add('hidden'); };
            cancelBtn.onclick = () => { onCancel(); modal.classList.add('hidden'); };
            modal.classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('barberia') || 'elite'; 
            
            const { data: shop, error } = await supabase.from('barberias').select('*').eq('slug', slug).single();
            if (error || !shop) return alert('Barber√≠a no encontrada.');

            currentShop = shop;
            shopConfig = shop.config || {};
            if (!shopConfig.barber_breaks) shopConfig.barber_breaks = [];
            
            document.title = currentShop.nombre + " - Agendamiento";
            generatedHours = generateTimeSlots(shop.apertura, shop.cierre, shop.intervalo);

            applyTheme();
            setupInputs();
            renderServiceOptions(); 
            
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            const storedClientId = localStorage.getItem(CLIENT_STORAGE_KEY);
            const storedAdminId = localStorage.getItem(ADMIN_STORAGE_KEY);
            
            if (storedClientId && storedClientId !== 'null') {
                const { data: client } = await supabase.from('clientes').select('*').eq('id', storedClientId).single();
                if (client) { currentUser = client; return showClientDashboard(); }
            } else if (storedAdminId && storedAdminId !== 'null') {
                 const { data: admin } = await supabase.from('barberos').select('*').eq('id', storedAdminId).single();
                if (admin) { currentUser = admin; return showAdminDashboard(); }
            }
            updateAdminDropdownVisibility(false);
        });

        function generateTimeSlots(startStr, endStr, intervalMins) {
            const slots = [];
            let [h, m] = startStr.split(':').map(Number);
            let [endH, endM] = endStr.split(':').map(Number);
            let current = new Date(); current.setHours(h, m, 0, 0);
            let end = new Date(); end.setHours(endH, endM, 0, 0);
            while (current < end) {
                const timeString = current.toLocaleTimeString('es-UY', {hour: '2-digit', minute:'2-digit', hour12: false});
                slots.push(timeString);
                current.setMinutes(current.getMinutes() + intervalMins);
            }
            return slots;
        }

        function applyTheme() {
            document.getElementById('shopName').innerText = currentShop.nombre;
            document.getElementById('headerSub').innerText = `${currentShop.sillas} Prof. ‚Ä¢ Abrimos ${currentShop.apertura.slice(0,5)}`;
            document.documentElement.style.setProperty('--color-primary', currentShop.color_primary);
            if(shopConfig.mensaje_aviso) {
                document.getElementById('shopNotice').classList.remove('hidden');
                document.getElementById('shopNoticeText').innerText = shopConfig.mensaje_aviso;
            } else document.getElementById('shopNotice').classList.add('hidden');
            if(shopConfig.mostrar_whatsapp && shopConfig.whatsapp) {
                document.getElementById('footerWpp').classList.remove('hidden');
                document.getElementById('wppLink').href = `https://wa.me/598${shopConfig.whatsapp.replace(/\D/g,'').slice(-9)}`;
            } else document.getElementById('footerWpp').classList.add('hidden');
        }

        function setupInputs() {
            const today = new Date().toISOString().split('T')[0];
            
            // Inicializar Flatpickr en el input de cliente
            calendarInstance = flatpickr("#datePicker", {
                ...flatpickrConfig,
                defaultDate: today,
                onChange: function(selectedDates, dateStr, instance) {
                    loadSlots();
                }
            });

            // Inicializar Flatpickr en el input de Admin
            adminCalendarInstance = flatpickr("#barberDatePicker", {
                ...flatpickrConfig,
                defaultDate: today,
                onChange: function(selectedDates, dateStr, instance) {
                    loadBarberDashboard();
                }
            });
            
            // Inicializar Flatpickr en el input Manual
            manualCalendarInstance = flatpickr("#manualDate", {
                ...flatpickrConfig,
                defaultDate: today
            });

            document.getElementById('btnConfirmBooking').addEventListener('click', createClientBooking);
            document.getElementById('loginPhone').addEventListener('input', checkPhoneRegistered);
            document.getElementById('btnActionLogin').addEventListener('click', handleClientLogin);
        }

        function renderServiceOptions() {
            const services = shopConfig.servicios || [{nombre: 'Corte', precio: 0}];
            const selects = [document.getElementById('serviceSelect'), document.getElementById('manualService')];
            selects.forEach(sel => {
                sel.innerHTML = '';
                services.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.nombre;
                    opt.innerText = `${s.nombre} ($${s.precio})`;
                    sel.appendChild(opt);
                });
            });
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function toggleDropdown(id) { document.getElementById(id).classList.toggle('hidden'); }

        function updateAdminDropdownVisibility(isAdmin) {
            if (isAdmin) {
                document.getElementById('adminOptions').classList.remove('hidden');
                document.getElementById('loginOption').classList.add('hidden');
            } else {
                document.getElementById('adminOptions').classList.add('hidden');
                document.getElementById('loginOption').classList.remove('hidden');
            }
        }

        function openAdminLoginAndCloseDropdown(e) { e.preventDefault(); toggleDropdown('adminDropdown'); toggleModal('modalBarberLogin'); }
        function openAccountSettingsAndCloseDropdown(e) { e.preventDefault(); toggleDropdown('adminDropdown'); toggleModal('modalAccountSettings'); }
        function adminLogoutAndCloseDropdown(e) { e.preventDefault(); toggleDropdown('adminDropdown'); logout(); }

        // --- CLIENTE ---
        async function checkPhoneRegistered() {
            const phone = document.getElementById('loginPhone').value;
            if (phone.length < 8) {
                document.getElementById('pinSection').classList.add('hidden');
                document.getElementById('nameSection').classList.add('hidden');
                document.getElementById('loginPin').value = '';
                document.getElementById('loginName').value = '';
                document.getElementById('btnActionLogin').innerText = 'Ingresar';
                return;
            }
            const { data } = await supabase.from('clientes').select('*').eq('barberia_id', currentShop.id).eq('celular', phone).single();
            document.getElementById('pinSection').classList.remove('hidden');
            const nameSec = document.getElementById('nameSection');
            const btn = document.getElementById('btnActionLogin');
            
            document.getElementById('loginPin').type = 'password';
            document.getElementById('pinToggleIcon').classList.remove('fa-eye-slash');
            document.getElementById('pinToggleIcon').classList.add('fa-eye');

            if (data) {
                nameSec.classList.add('hidden');
                document.getElementById('loginName').value = data.nombre;
                document.getElementById('pinHint').innerText = "Ingresa tu PIN";
                btn.innerText = "Ingresar";
            } else {
                nameSec.classList.remove('hidden');
                document.getElementById('loginName').value = '';
                document.getElementById('pinHint').innerText = "Crea un PIN";
                btn.innerText = "Registrarme";
            }
        }

        async function handleClientLogin() {
            const phone = document.getElementById('loginPhone').value;
            const pin = document.getElementById('loginPin').value;
            let name = document.getElementById('loginName').value;
            if (phone.length < 8 || pin.length < 4) { showToast("Datos incompletos", true); return; }

            const { data: existing } = await supabase.from('clientes').select('*').eq('barberia_id', currentShop.id).eq('celular', phone).eq('pin', pin).single();
            if (existing) {
                currentUser = existing; 
                localStorage.setItem(CLIENT_STORAGE_KEY, currentUser.id); 
                localStorage.removeItem(ADMIN_STORAGE_KEY);
                showClientDashboard();
            } else {
                const { data: existingName } = await supabase.from('clientes').select('*').eq('barberia_id', currentShop.id).eq('celular', phone).single();
                if (existingName) { showToast("PIN Incorrecto", true); return; }
                if (!name) { showToast("Falta nombre", true); return; }
                const { data, error } = await supabase.from('clientes').insert({ barberia_id: currentShop.id, celular: phone, nombre: name, pin: pin }).select().single();
                if (!error) { 
                    currentUser = data; 
                    localStorage.setItem(CLIENT_STORAGE_KEY, currentUser.id);
                    localStorage.removeItem(ADMIN_STORAGE_KEY);
                    showClientDashboard(); 
                } else showToast("Error: " + error.message, true);
            }
        }

        async function showClientDashboard() {
            document.getElementById('viewLogin').classList.add('hidden');
            document.getElementById('viewClient').classList.remove('hidden');
            document.getElementById('viewBarber').classList.add('hidden');
            document.getElementById('fabAdd').classList.add('hidden');
            document.getElementById('clientNameDisplay').innerText = currentUser.nombre.split(' ')[0];
            document.title = currentShop.nombre + " - Agendamiento";
            updateAdminDropdownVisibility(false);

            const todayISO = new Date().toISOString().split('T')[0];
            const { data: appt } = await supabase.from('turnos').select('*').eq('barberia_id', currentShop.id).eq('cliente_id', currentUser.id).eq('estado', 'pendiente').gte('fecha', todayISO).order('fecha', {ascending: true}).single();

            if (appt) {
                document.getElementById('activeAppointmentCard').classList.remove('hidden');
                document.getElementById('newBookingContainer').classList.add('hidden');
                document.getElementById('activeDate').innerText = formatDate(appt.fecha);
                document.getElementById('activeTime').innerText = appt.hora.slice(0,5);
                document.getElementById('activeService').innerText = appt.servicio;
                currentUser.activeApptId = appt.id;
            } else {
                document.getElementById('activeAppointmentCard').classList.add('hidden');
                document.getElementById('newBookingContainer').classList.remove('hidden');
                loadSlots();
            }
        }

        async function loadSlots() {
            // Usamos el valor del input de flatpickr (formato YYYY-MM-DD)
            const dateStr = document.getElementById('datePicker').value;
            const dateObj = new Date(dateStr + 'T00:00:00'); 
            const dayOfWeek = dateObj.getDay(); 
            const openDays = shopConfig.dias_laborables || [1,2,3,4,5,6];
            
            if (!openDays.includes(dayOfWeek)) {
                document.getElementById('slotsGrid').innerHTML = '';
                document.getElementById('closedMessage').classList.remove('hidden');
                return;
            }
            document.getElementById('closedMessage').classList.add('hidden');

            const grid = document.getElementById('slotsGrid');
            grid.innerHTML = '<p class="col-span-3 text-center">Cargando...</p>';
            selectedTime = null;
            document.getElementById('btnConfirmBooking').disabled = true;

            const { data: turnos } = await supabase.from('turnos').select('hora').eq('barberia_id', currentShop.id).eq('fecha', dateStr).neq('estado', 'cancelado');
            const occupation = {};
            turnos.forEach(t => { const h = t.hora.slice(0,5); occupation[h] = (occupation[h] || 0) + 1; });

            const capacity = currentShop.sillas || 1;
            grid.innerHTML = '';
            const barberBreaks = shopConfig.barber_breaks || [];

            generatedHours.forEach(time => {
                let currentCapacity = capacity;
                barberBreaks.forEach(breakTime => {
                    if (breakTime.start && breakTime.end) {
                        if (time >= breakTime.start && time < breakTime.end) currentCapacity--;
                    }
                });
                
                const currentCount = occupation[time] || 0;
                const isFull = currentCount >= Math.max(0, currentCapacity);
                const isAvailable = (Math.max(0, currentCapacity) - currentCount) > 0;

                const btn = document.createElement('button');
                btn.className = `slot-btn border rounded-lg py-3 font-medium text-sm flex flex-col items-center justify-center ${ !isAvailable ? 'occupied' : 'available bg-white border-gray-200 text-gray-700' }`;
                let badgeHtml = (isAvailable && (Math.max(0, currentCapacity) - currentCount) <= 2) ? `<span class="spots-badge">${Math.max(0, currentCapacity) - currentCount}</span>` : '';
                btn.innerHTML = `${time}${badgeHtml}`;

                if (isAvailable) {
                    btn.onclick = () => {
                        document.querySelectorAll('.slot-btn').forEach(b => {
                            if (b.classList.contains('available')) {
                                b.classList.remove('selected', 'bg-primary', 'text-white');
                                b.classList.add('bg-white', 'text-gray-700');
                            }
                        });
                        btn.classList.remove('bg-white', 'text-gray-700');
                        btn.classList.add('selected', 'bg-primary', 'text-white');
                        selectedTime = time;
                        document.getElementById('btnConfirmBooking').disabled = false;
                    }
                }
                grid.appendChild(btn);
            });
        }

        async function createClientBooking() {
            const date = document.getElementById('datePicker').value;
            const service = document.getElementById('serviceSelect').value;
            const { error } = await supabase.from('turnos').insert({ barberia_id: currentShop.id, cliente_id: currentUser.id, fecha: date, hora: selectedTime, servicio: service });
            if (!error) { showToast("¬°Turno confirmado! üëç"); showClientDashboard(); }
            else showToast("Error: " + error.message, true);
        }

        async function cancelMyAppointment() {
            showConfirmationModal("¬øEst√°s seguro de que quieres CANCELAR tu turno?", 
                async () => {
                    await supabase.from('turnos').update({ estado: 'cancelado' }).eq('id', currentUser.activeApptId);
                    showToast("Turno cancelado.", true);
                    showClientDashboard();
                }, () => {} );
        }

        // --- ADMIN ---
        function showAdminDashboard() {
            document.getElementById('viewLogin').classList.add('hidden');
            document.getElementById('viewClient').classList.add('hidden');
            document.getElementById('viewBarber').classList.remove('hidden');
            document.getElementById('fabAdd').classList.remove('hidden');
            document.title = currentShop.nombre + " - Administraci√≥n";
            updateAdminDropdownVisibility(true);
            loadBarberDashboard();
        }

        function switchAdminTab(tabName) {
            const tabA = document.getElementById('tabAgenda'); const tabC = document.getElementById('tabConfig');
            const panA = document.getElementById('panelAgenda'); const panC = document.getElementById('panelConfig');
            if(tabName === 'agenda') {
                tabA.classList.add('text-primary', 'border-b-2'); tabA.classList.remove('text-gray-500');
                tabC.classList.remove('text-primary', 'border-b-2'); tabC.classList.add('text-gray-500');
                panA.classList.remove('hidden'); panC.classList.add('hidden');
                loadBarberDashboard();
            } else {
                tabC.classList.add('text-primary', 'border-b-2'); tabC.classList.remove('text-gray-500');
                tabA.classList.remove('text-primary', 'border-b-2'); tabA.classList.add('text-gray-500');
                panC.classList.remove('hidden'); panA.classList.add('hidden');
                loadConfigForm();
            }
        }
        
        async function loginBarber() {
            const username = document.getElementById('adminUsername').value;
            const pass = document.getElementById('adminPass').value;
            const { data: barber } = await supabase.from('barberos').select('*').eq('barberia_id', currentShop.id).eq('email', username).eq('password', pass).single();
            if (barber) {
                currentUser = barber;
                localStorage.setItem(ADMIN_STORAGE_KEY, currentUser.id); localStorage.removeItem(CLIENT_STORAGE_KEY);
                document.getElementById('modalBarberLogin').classList.add('hidden');
                showAdminDashboard();
            } else showToast("Datos incorrectos", true);
        }

        async function loadBarberDashboard() {
            const date = document.getElementById('barberDatePicker').value;
            const list = document.getElementById('barberAppointmentsList');
            const summary = document.getElementById('occupancySummary');
            list.innerHTML = '<p class="text-center text-gray-400">Cargando...</p>';
            const { data: appts } = await supabase.from('turnos').select(`id, hora, servicio, estado, clientes (nombre, celular)`).eq('barberia_id', currentShop.id).eq('fecha', date).order('hora');
            list.innerHTML = ''; summary.innerHTML = '';
            if (!appts.length) list.innerHTML = '<p class="text-center text-gray-400 py-10">Agenda libre üèñÔ∏è</p>';

            const occupation = {};
            appts.forEach(a => { if(a.estado!=='cancelado') occupation[a.hora.slice(0,5)] = (occupation[a.hora.slice(0,5)]||0)+1; });
            generatedHours.forEach(h => {
                const count = occupation[h] || 0;
                if(count > 0) {
                    const div = document.createElement('div');
                    div.className = `flex-shrink-0 px-3 py-1 rounded-lg text-xs font-bold whitespace-nowrap ${count >= currentShop.sillas ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`;
                    div.innerText = `${h}: ${count}/${currentShop.sillas}`;
                    summary.appendChild(div);
                }
            });

            // CORRECCI√ìN: Bot√≥n de borrado para cancelados
            appts.forEach(a => {
                const isBlocked = a.clientes.nombre === 'PAUSA'; 
                let cardClass = 'bg-white shadow-sm border-l-4 border-green-500';
                let statusLabel = `<span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded">‚úÖ EN ESPERA</span>`;
                
                // Acci√≥n por defecto: Cancelar
                let actionBtn = `<button onclick="barberCancel(${a.id})" class="text-red-500 p-2 hover:bg-red-100 rounded-full transition" title="Cancelar Turno"><i class="fas fa-times"></i></button>`;

                if (a.estado === 'cancelado') {
                    cardClass = 'bg-red-50 border-l-4 border-red-300 opacity-75';
                    statusLabel = `<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded">‚ùå CANCELADO</span>`;
                    // Acci√≥n si cancelado: Borrar (Papelera)
                    actionBtn = `<button onclick="deleteAppt(${a.id})" class="text-gray-500 p-2 hover:bg-gray-200 rounded-full transition" title="Borrar Definitivamente"><i class="fas fa-trash-alt"></i></button>`;
                } else if (isBlocked) {
                    cardClass = 'bg-yellow-50 border-l-4 border-yellow-400';
                    statusLabel = `<span class="text-xs font-bold text-yellow-700 bg-yellow-100 px-2 py-1 rounded">‚è∏Ô∏è PAUSA</span>`;
                }

                const item = document.createElement('div');
                item.className = `border rounded-xl p-4 flex justify-between items-center ${cardClass}`;
                item.innerHTML = `
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-lg text-gray-800">${a.hora.slice(0,5)}</span>
                            ${statusLabel}
                        </div>
                        <div class="text-sm font-medium ${isBlocked ? 'text-yellow-700' : 'text-gray-700'}">${a.clientes.nombre}</div>
                        <div class="text-xs text-gray-500">${a.servicio}</div>
                    </div>
                    ${actionBtn}
                `;
                list.appendChild(item);
            });
        }

        async function barberCancel(id) {
            showConfirmationModal("¬øCancelar este turno?", 
                async () => {
                    await supabase.from('turnos').update({estado:'cancelado'}).eq('id', id);
                    showToast("Turno cancelado.");
                    loadBarberDashboard();
                }, () => {});
        }
        
        // NUEVA FUNCI√ìN: Borrar definitivamente
        async function deleteAppt(id) {
            showConfirmationModal("¬øBorrar definitivamente del historial?", 
                async () => {
                    const { error } = await supabase.from('turnos').delete().eq('id', id);
                    if(!error) {
                        showToast("Registro eliminado.");
                        loadBarberDashboard();
                    } else showToast("Error al borrar", true);
                }, () => {});
        }

        // --- CONFIG ---
        function loadConfigForm() {
            document.getElementById('cfgOpen').value = currentShop.apertura.slice(0,5);
            document.getElementById('cfgClose').value = currentShop.cierre.slice(0,5);
            document.getElementById('cfgInterval').value = currentShop.intervalo;
            document.getElementById('cfgChairs').value = currentShop.sillas;
            document.getElementById('cfgMsg').value = shopConfig.mensaje_aviso || '';
            document.getElementById('cfgShowWpp').checked = shopConfig.mostrar_whatsapp || false;
            document.getElementById('cfgWppNumber').value = shopConfig.whatsapp || '';
            
            const days = shopConfig.dias_laborables || [];
            document.querySelectorAll('input[name="workday"]').forEach(cb => { cb.checked = days.includes(parseInt(cb.value)); });
            
            renderServicesListDOM();
            renderBarberBreaks();
        }
        
        function renderBarberBreaks() {
            const container = document.getElementById('barberBreaksContainer');
            container.innerHTML = '';
            const chairs = parseInt(document.getElementById('cfgChairs').value) || 1;
            while (shopConfig.barber_breaks.length < chairs) shopConfig.barber_breaks.push({ id: shopConfig.barber_breaks.length + 1, start: '', end: '' });
            shopConfig.barber_breaks = shopConfig.barber_breaks.slice(0, chairs);

            shopConfig.barber_breaks.forEach((breakTime, index) => {
                const div = document.createElement('div');
                div.className = 'flex gap-2 items-center';
                div.innerHTML = `
                    <label class="text-sm font-medium w-16">Barbero ${index + 1}:</label>
                    <input type="tel" inputmode="numeric" class="p-1 border rounded w-full text-sm text-center time-mask" placeholder="Inicio" data-barber-id="${index}" data-time-type="start" value="${breakTime.start || ''}" oninput="maskTime(this)">
                    <span class="text-xs">-</span>
                    <input type="tel" inputmode="numeric" class="p-1 border rounded w-full text-sm text-center time-mask" placeholder="Fin" data-barber-id="${index}" data-time-type="end" value="${breakTime.end || ''}" oninput="maskTime(this)">
                `;
                container.appendChild(div);
            });
            // Listeners para guardar cambios en inputs de pausa
            container.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const id = parseInt(e.target.dataset.barberId);
                    const type = e.target.dataset.timeType;
                    shopConfig.barber_breaks[id][type] = e.target.value;
                });
            });
        }

        function renderServicesListDOM() {
            const container = document.getElementById('servicesList'); container.innerHTML = '';
            (shopConfig.servicios || []).forEach((s, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-50 p-2 rounded border';
                div.innerHTML = `<span class="text-sm">${s.nombre} - $${s.precio}</span><button onclick="removeService(${index})" class="text-red-500 font-bold px-2">√ó</button>`;
                container.appendChild(div);
            });
        }
        function addServiceDOM() {
            const name = document.getElementById('newSvcName').value; const price = document.getElementById('newSvcPrice').value;
            if(!name || !price) return;
            if(!shopConfig.servicios) shopConfig.servicios = [];
            shopConfig.servicios.push({nombre: name, precio: parseInt(price)});
            document.getElementById('newSvcName').value = ''; document.getElementById('newSvcPrice').value = '';
            renderServicesListDOM();
        }
        function removeService(index) { shopConfig.servicios.splice(index, 1); renderServicesListDOM(); }

        async function changeAdminPassword() {
            const currentPass = document.getElementById('currentPass').value; const newPass = document.getElementById('newPass').value; const confirmPass = document.getElementById('confirmNewPass').value;
            if (!currentPass || !newPass || !confirmPass) return showToast("Faltan datos", true);
            if (newPass !== confirmPass) return showToast("No coinciden", true);
            if (currentPass !== currentUser.password) return showToast("Contrase√±a actual mal", true);
            const { error } = await supabase.from('barberos').update({ password: newPass }).eq('id', currentUser.id);
            if (!error) { currentUser.password = newPass; showToast("Actualizado"); toggleModal('modalAccountSettings'); } 
            else showToast("Error", true);
        }

        async function saveConfig() {
            const newOpen = document.getElementById('cfgOpen').value;
            const newClose = document.getElementById('cfgClose').value;
            const newInterval = parseInt(document.getElementById('cfgInterval').value);
            const newChairs = parseInt(document.getElementById('cfgChairs').value);
            const activeDays = Array.from(document.querySelectorAll('input[name="workday"]:checked')).map(cb => parseInt(cb.value));
            
            shopConfig.dias_laborables = activeDays;
            shopConfig.mensaje_aviso = document.getElementById('cfgMsg').value;
            shopConfig.mostrar_whatsapp = document.getElementById('cfgShowWpp').checked;
            shopConfig.whatsapp = document.getElementById('cfgWppNumber').value;
            shopConfig.barber_breaks = shopConfig.barber_breaks.filter(b => b.start && b.end); 

            const { error } = await supabase.from('barberias').update({
                apertura: newOpen, cierre: newClose, intervalo: newInterval, sillas: newChairs, config: shopConfig
            }).eq('id', currentShop.id);

            if(!error) {
                showToast("Guardado");
                currentShop.apertura = newOpen; currentShop.cierre = newClose; currentShop.intervalo = newInterval; currentShop.sillas = newChairs;
                generatedHours = generateTimeSlots(currentShop.apertura, currentShop.cierre, currentShop.intervalo);
                renderServiceOptions(); showAdminDashboard(); switchAdminTab('config'); 
            } else showToast("Error: " + error.message, true);
        }

        async function createManualBooking() {
            const phone = document.getElementById('manualPhone').value; const name = document.getElementById('manualName').value;
            const date = document.getElementById('manualDate').value; const time = document.getElementById('manualTime').value; const service = document.getElementById('manualService').value;
            if (!name || !date || !time) return showToast("Faltan datos", true);
            let clientId;
            const { data: existing } = await supabase.from('clientes').select('id').eq('barberia_id', currentShop.id).eq('celular', phone || '000000000').single();
            if (existing) clientId = existing.id;
            else {
                const { data: newC } = await supabase.from('clientes').insert({ barberia_id: currentShop.id, celular: phone || '000000000', nombre: name, pin: '0000' }).select().single();
                clientId = newC.id;
            }
            const { error } = await supabase.from('turnos').insert({ barberia_id: currentShop.id, cliente_id: clientId, fecha: date, hora: time, servicio: service });
            if(!error) { showToast("Agendado"); toggleModal('modalManualBooking'); loadBarberDashboard(); }
            else showToast(error.message, true);
        }
        
        const DAYS_ES = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        function formatDate(d) {
            const date = new Date(d + 'T00:00:00'); 
            return `${DAYS_ES[date.getDay()]}, ${date.toLocaleDateString('es-UY', { day: 'numeric', month: 'long' })}`;
        }

        function logout() { 
            currentUser = null; localStorage.removeItem(CLIENT_STORAGE_KEY); localStorage.removeItem(ADMIN_STORAGE_KEY);
            document.title = currentShop.nombre + " - Agendamiento"; updateAdminDropdownVisibility(false);
            document.getElementById('viewBarber').classList.add('hidden'); document.getElementById('viewClient').classList.add('hidden');
            document.getElementById('viewLogin').classList.remove('hidden'); document.getElementById('fabAdd').classList.add('hidden');
            document.getElementById('loginPhone').value = ''; document.getElementById('loginPin').value = '';
            document.getElementById('pinSection').classList.add('hidden'); document.getElementById('nameSection').classList.add('hidden');
        }
    </script>
</body>
</html>
