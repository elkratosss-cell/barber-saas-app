<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberSaaS - Agenda Online</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div class="container">
        <header>
            <h1 id="barberiaNombre">Agenda Barber铆a Online</h1>
            <div id="adminControls" class="admin-controls" style="display:none;">
                <button onclick="toggleAdminDropdown()">锔 Administrar</button>
                <div id="adminDropdown" style="display:none;">
                    <button onclick="showAdminDashboard()">Dashboard</button>
                    <button onclick="logoutAdmin()">Cerrar Sesi贸n</button>
                </div>
            </div>
        </header>

        <div id="loginPanel">
            <h2>Ingreso de Cliente</h2>
            <div id="loginForm">
                <input type="text" id="phoneInput" placeholder="N煤mero de Celular (Ej: 099123456)" maxlength="9">
                <input type="text" id="pinInput" placeholder="PIN de 4 d铆gitos" maxlength="4" style="display:none;">
                <button id="btnActionLogin" onclick="handleLoginFlow()">Solicitar PIN</button>
            </div>
        </div>

        <div id="panelAgenda">
            <h2>Bienvenido/a <span id="nombreCliente"></span></h2>
            <p>Selecciona la fecha y hora para tu turno:</p>
            <input type="date" id="dateInput">
            <div id="horarios">
                </div>
        </div>

        <div id="panelAdmin">
            <h2>Panel de Administraci贸n</h2>
            <div id="configuracionLocal">
                <h3>Datos del Local</h3>
                <label for="cfgName">Nombre de la Barber铆a:</label>
                <input type="text" id="cfgName">
                
                <label for="cfgAddress">Direcci贸n del Local:</label>
                <input type="text" id="cfgAddress" placeholder="Ej: Av. 18 de Julio 1234"> 
                
                <label for="cfgStart">Hora de Apertura:</label>
                <input type="time" id="cfgStart">
                <label for="cfgEnd">Hora de Cierre:</label>
                <input type="time" id="cfgEnd">
                <button onclick="saveConfig()">Guardar Configuraci贸n</button>
            </div>
            
            <hr>
            
            <div id="gestionTurnos">
                <h3>Gesti贸n de Turnos</h3>
                <input type="date" id="adminDateInput">
                <div id="adminTurnosList">
                    </div>
            </div>
        </div>
    </div>

    <div id="snackbar" class="snackbar"></div>

    <script>
        // =========================================================================
        // === 1. VARIABLES GLOBALES Y CONFIGURACIN (CORRECCIN DE ReferenceError) ===
        // 隆ESTAS LNEAS DEBEN IR PRIMERO PARA EVITAR ERRORES DE INICIALIZACIN!
        // =========================================================================

        //  CAMBIAR ESTAS VARIABLES CON TUS DATOS REALES DE SUPABASE
        const SUPABASE_URL = 'https://hqoyjsngydafaagsrzlg.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhxb3lqc25neWRhZmFhZ3NyemxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MDI5MDQsImV4cCI6MjA3OTk3ODkwNH0.WyTlANZLTRd6IlhxuDlQai8Zz6dgexGPvwXmBr7HsZs'; // <--- 隆COLOCA TU CLAVE ANON REAL AQU!

        // URL EXPLCITA PARA LA EDGE FUNCTION (CRTICO: Soluciona el error CORS)
        const TWILIO_FUNCTION_URL = 'https://hqoyjsngydafaagsrzlg.supabase.co/functions/v1/send-pin';

        // Inicializaci贸n del cliente Supabase
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Estado de la sesi贸n
        let currentClient = null;
        let isAdmin = false;

        // Estado del flujo de login: 1 = Pedir PIN, 2 = Verificar PIN
        let loginStep = 1; 

        // Configuraci贸n global
        let barberiaConfig = {}; 

        // =========================================================================
        // === 2. FUNCIONES DE UTILIDAD ===
        // =========================================================================

        //  NOTA: Tendr谩s que darle estilo a esta funci贸n con tu CSS
        function showSnackbar(message, type = 'default') {
            const sb = document.getElementById("snackbar");
            sb.textContent = message;
            // Usa tus clases CSS originales si tienes un snackbar con estilos
            sb.className = `snackbar show ${type}`; 
            setTimeout(function(){ sb.className = sb.className.replace("show", ""); }, 3000);
        }

        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        // =========================================================================
        // === LGICA DE LOGIN (CORRECCIN DE TWILIO) ===
        // =========================================================================

        function updateLoginUI() {
            const phoneInput = document.getElementById('phoneInput');
            const pinInput = document.getElementById('pinInput');
            const btn = document.getElementById('btnActionLogin');

            if (loginStep === 1) {
                pinInput.style.display = 'none';
                btn.textContent = 'Solicitar PIN';
            } else {
                pinInput.style.display = 'block';
                btn.textContent = 'Verificar PIN';
            }
        }

        async function handleLoginFlow() {
            const phoneInput = document.getElementById('phoneInput');
            const pinInput = document.getElementById('pinInput');
            const btn = document.getElementById('btnActionLogin');
            const phone = phoneInput.value.trim();

            if (!phone || phone.length < 9) {
                showSnackbar('Introduce un n煤mero de 9 d铆gitos (Ej: 099123456).', 'error');
                return;
            }

            btn.disabled = true;
            
            if (loginStep === 1) {
                // Paso 1: Solicitar PIN y enviarlo por SMS
                await requestPin(phone, btn);
            } else {
                // Paso 2: Verificar el PIN
                const pin = pinInput.value.trim();
                if (!pin || pin.length !== 4) {
                    showSnackbar('Introduce el PIN de 4 d铆gitos recibido por SMS.', 'error');
                    btn.disabled = false;
                    return;
                }
                await verifyPin(phone, pin, btn);
            }
        }

        /**
         * Llama a la Edge Function de Twilio para enviar el SMS.
         */
        async function requestPin(phone, btn) {
            const generatedPin = Math.floor(1000 + Math.random() * 9000).toString(); // Genera PIN de 4 d铆gitos

            try {
                // 1. Guardar el PIN en la base de datos (tabla clientes)
                const { error: dbError } = await supabase
                    .from('clientes')
                    .upsert({ telefono: phone, pin: generatedPin, ultima_conexion: new Date().toISOString() }, { onConflict: 'telefono' });

                if (dbError) {
                    console.error('Error al guardar PIN en DB:', dbError);
                    showSnackbar('Error interno al preparar el PIN.', 'error');
                    return;
                }
                
                // 2. Llamar a la Edge Function de Twilio
                const twilioUrl = TWILIO_FUNCTION_URL; // Usamos la URL CRITICA corregida

                const response = await fetch(twilioUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to: phone,
                        pin: generatedPin,
                    }),
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showSnackbar('PIN enviado correctamente por SMS. Por favor, rev铆salo.', 'success');
                    loginStep = 2; // Avanza al paso de verificaci贸n
                    updateLoginUI();
                } else {
                    console.error('Error al enviar SMS:', data.error, data.twilio_message);
                    showSnackbar(data.twilio_message || 'Error desconocido al solicitar el PIN. Revisa los logs de Supabase.', 'error');
                }
            } catch (error) {
                console.error('Error de red/fetch al llamar a la funci贸n:', error);
                showSnackbar('Error de conexi贸n con el servicio de SMS.', 'error');
            } finally {
                btn.disabled = false;
            }
        }

        /**
         * Verifica el PIN introducido por el cliente contra el guardado en la DB.
         */
        async function verifyPin(phone, pin, btn) {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('id, nombre, pin, es_admin')
                    .eq('telefono', phone)
                    .single();

                if (error || !data) {
                    showSnackbar('Error: N煤mero no registrado o PIN no solicitado.', 'error');
                    return;
                }

                if (data.pin === pin) {
                    // PIN correcto
                    currentClient = data;
                    showSnackbar(`Bienvenido/a, ${data.nombre || 'Cliente'}`, 'success');
                    
                    if (data.es_admin) {
                        isAdmin = true;
                        showAdminDashboard();
                    } else {
                        isAdmin = false;
                        showAgendaPanel();
                    }

                    // Limpiar campos y resetear flujo
                    document.getElementById('phoneInput').value = '';
                    document.getElementById('pinInput').value = '';
                    loginStep = 1; 

                } else {
                    showSnackbar('PIN incorrecto. Intenta de nuevo.', 'error');
                }
            } catch (error) {
                console.error('Error de verificaci贸n:', error);
                showSnackbar('Error interno de verificaci贸n.', 'error');
            } finally {
                btn.disabled = false;
            }
        }

        // =========================================================================
        // === GESTIN DE VISTAS Y ADMINISTRACIN ===
        // =========================================================================

        function hideAllPanels() {
            document.getElementById('loginPanel').style.display = 'none';
            document.getElementById('panelAgenda').style.display = 'none';
            document.getElementById('panelAdmin').style.display = 'none';
            document.getElementById('adminControls').style.display = 'none';
        }

        function showAgendaPanel() {
            hideAllPanels();
            document.getElementById('panelAgenda').style.display = 'block';
            document.getElementById('nombreCliente').textContent = currentClient.nombre || currentClient.telefono;
            loadBarberiaInfo();
            document.getElementById('dateInput').value = getTodayDateString();
            document.getElementById('dateInput').onchange = loadAvailableHours;
            loadAvailableHours();
        }

        function showAdminDashboard() {
            hideAllPanels();
            document.getElementById('panelAdmin').style.display = 'block';
            document.getElementById('adminControls').style.display = 'flex';
            document.getElementById('adminDateInput').value = getTodayDateString();
            document.getElementById('adminDateInput').onchange = loadAdminAppointments;
            loadAdminAppointments();
            loadConfig();
        }

        function toggleAdminDropdown() {
            const dropdown = document.getElementById('adminDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function logoutAdmin() {
            currentClient = null;
            isAdmin = false;
            hideAllPanels();
            document.getElementById('loginPanel').style.display = 'block';
            document.getElementById('adminDropdown').style.display = 'none';
            showSnackbar('Sesi贸n cerrada.', 'success');
        }
        
        async function loadConfig() {
            const { data, error } = await supabase
                .from('barberias')
                .select('*')
                .eq('id', 1)
                .single();

            if (data) {
                document.getElementById('cfgName').value = data.nombre || '';
                document.getElementById('cfgAddress').value = data.direccion || '';
                document.getElementById('cfgStart').value = data.horario_inicio || '09:00';
                document.getElementById('cfgEnd').value = data.horario_fin || '18:00';
            }
        }
        
        async function saveConfig() {
            const name = document.getElementById('cfgName').value;
            const address = document.getElementById('cfgAddress').value;
            const start = document.getElementById('cfgStart').value;
            const end = document.getElementById('cfgEnd').value;
            
            if (!name || !start || !end || !address) {
                showSnackbar('Todos los campos de configuraci贸n son obligatorios.', 'error');
                return;
            }

            const { error } = await supabase
                .from('barberias')
                .update({ 
                    nombre: name, 
                    horario_inicio: start, 
                    horario_fin: end,
                    direccion: address 
                })
                .eq('id', 1);

            if (error) {
                console.error('Error al guardar configuraci贸n:', error);
                showSnackbar('Error al guardar la configuraci贸n.', 'error');
            } else {
                showSnackbar('Configuraci贸n guardada con 茅xito.', 'success');
                loadBarberiaInfo();
            }
        }
        
        async function loadAdminAppointments() {
            const date = document.getElementById('adminDateInput').value;
            const container = document.getElementById('adminTurnosList');
            container.innerHTML = 'Cargando turnos...';

            const { data, error } = await supabase
                .from('turnos')
                .select(`
                    id, 
                    hora, 
                    clientes (nombre, telefono)
                `)
                .eq('fecha', date)
                .order('hora', { ascending: true });

            if (error) {
                console.error('Error al cargar turnos de admin:', error);
                container.innerHTML = 'Error al cargar turnos.';
                return;
            }

            if (data.length === 0) {
                container.innerHTML = `<p>No hay turnos agendados para el ${date}.</p>`;
                return;
            }

            let html = '<ul>';
            data.forEach(turno => {
                const cliente = turno.clientes;
                html += `<li>${turno.hora} - ${cliente.nombre || cliente.telefono} 
                         <button onclick="cancelAppointment(${turno.id})">Cancelar</button>
                         </li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        async function cancelAppointment(turnoId) {
            if (!confirm('驴Est谩s seguro de cancelar este turno?')) return;

            const { error } = await supabase
                .from('turnos')
                .delete()
                .eq('id', turnoId);

            if (error) {
                console.error('Error al cancelar turno:', error);
                showSnackbar('Error al cancelar turno.', 'error');
            } else {
                showSnackbar('Turno cancelado con 茅xito.', 'success');
                loadAdminAppointments();
            }
        }

        // =========================================================================
        // === LGICA DE AGENDAMIENTO ===
        // =========================================================================

        async function loadBarberiaInfo() {
            const { data, error } = await supabase
                .from('barberias')
                .select('*')
                .eq('id', 1)
                .single();

            if (data) {
                barberiaConfig = data;
                document.getElementById('barberiaNombre').textContent = data.nombre || 'Agenda Barber铆a Online';
            }
        }

        async function loadAvailableHours() {
            const date = document.getElementById('dateInput').value;
            const container = document.getElementById('horarios');
            container.innerHTML = 'Cargando horarios...';

            if (!barberiaConfig.horario_inicio) {
                container.innerHTML = 'Configuraci贸n de horarios no cargada.';
                return;
            }
            
            // 1. Obtener turnos ya ocupados para la fecha
            const { data: occupiedHours, error } = await supabase
                .from('turnos')
                .select('hora')
                .eq('fecha', date);

            if (error) {
                console.error('Error al cargar horas ocupadas:', error);
                container.innerHTML = 'Error al cargar horarios.';
                return;
            }

            const occupiedSet = new Set(occupiedHours.map(t => t.hora));
            
            // 2. Generar todos los horarios posibles (cada 30 min)
            const startHour = parseInt(barberiaConfig.horario_inicio.split(':')[0]);
            const endHour = parseInt(barberiaConfig.horario_fin.split(':')[0]);
            let html = '';

            for (let h = startHour; h < endHour; h++) {
                // Turnos a la hora y a la media hora
                const times = [`${h.toString().padStart(2, '0')}:00`, `${h.toString().padStart(2, '0')}:30`];

                times.forEach(time => {
                    const isOccupied = occupiedSet.has(time);
                    // Usa tus clases CSS para 'disponible' y 'ocupado' aqu铆
                    const className = isOccupied ? 'ocupado' : 'disponible';
                    const disabled = isOccupied ? 'disabled' : '';
                    
                    html += `<button class="${className}" ${disabled} onclick="bookAppointment('${date}', '${time}')">${time}</button>`;
                });
            }

            container.innerHTML = html || 'No hay horarios disponibles en esta fecha.';
        }

        async function bookAppointment(date, time) {
            if (!currentClient || !currentClient.id) {
                showSnackbar('Debes iniciar sesi贸n para agendar.', 'error');
                return;
            }

            const appointmentData = {
                id_cliente: currentClient.id,
                fecha: date,
                hora: time,
            };

            const { error } = await supabase
                .from('turnos')
                .insert([appointmentData]);

            if (error && error.code === '23505') {
                 showSnackbar('Ese turno fue tomado, por favor selecciona otro.', 'error');
            } else if (error) {
                console.error('Error al agendar:', error);
                showSnackbar('Error al agendar turno.', 'error');
            } else {
                showSnackbar(`Turno agendado con 茅xito para el ${date} a las ${time}.`, 'success');
                loadAvailableHours();
            }
        }

        // =========================================================================
        // === 3. INICIALIZACIN (DEBE IR LTIMO) ===
        // =========================================================================

        document.addEventListener('DOMContentLoaded', () => {
            hideAllPanels();
            document.getElementById('loginPanel').style.display = 'block';
            loadBarberiaInfo(); 
            updateLoginUI(); 
        });
    </script>
</body>
</html>
